# FastAPI Reqres

Микросервис на FastAPI с автотестами.

## Установка и запуск

### 1. Установка зависимостей

```bash
# Установка Poetry (если еще не установлен)
curl -sSL https://install.python-poetry.org | python3 -

# Установка зависимостей проекта
poetry install
```

### 2. Настройка окружения

Создайте `.env` файл в корне проекта:

```bash
# API Configuration
API_URL=http://localhost:8000
API_KEY=reqres-free-v1
HOST=0.0.0.0
PORT=8000
```

**Важно:** Если сервис недоступен, тесты автоматически остановятся с сообщением о проблеме.

### 3. Запуск сервера

```bash
# Через Poetry
poetry run python app/main.py

# Или активировать виртуальное окружение
poetry shell
python app/main.py
```

Сервер: http://localhost:8000

### 4. Запуск тестов

```bash
# Все тесты
poetry run pytest tests/ -v

# Конкретные группы тестов
poetry run pytest tests/test_smoke.py -v     # Smoke тесты
poetry run pytest tests/test_users.py -v     # Тесты пользователей
poetry run pytest tests/test_auth.py -v      # Тесты аутентификации
poetry run pytest tests/test_crud.py -v      # CRUD операции
poetry run pytest tests/test_resources.py -v # Тесты ресурсов
poetry run pytest tests/test_special.py -v   # Специальные тесты
```

## API

### Статус

```
GET /status                          # Статус приложения
```

### Пользователи

```
GET /api/users?page=1&per_page=6     # Список пользователей
GET /api/users?delay=3               # Список с задержкой
GET /api/users/2                     # Один пользователь
GET /api/users/999                   # 404 Not Found
POST /api/users                      # Создание пользователя  
PUT /api/users/2                     # Полное обновление
PATCH /api/users/2                   # Частичное обновление
DELETE /api/users/2                  # Удаление (204)
```

### Ресурсы

```
GET /api/unknown                     # Список ресурсов
GET /api/unknown/2                   # Один ресурс
GET /api/unknown/23                  # 404 Not Found
```

### Аутентификация

```
POST /api/register                   # Регистрация пользователя
POST /api/login                      # Вход пользователя
```

## Структура проекта

```
├── app/
│   ├── main.py              # FastAPI сервер
│   └── models.py            # Pydantic модели для валидации
├── tests/
│   ├── test_auth.py         # Тесты аутентификации
│   ├── test_crud.py         # CRUD операции
│   ├── test_resources.py    # Тесты ресурсов
│   ├── test_smoke.py        # Smoke тесты
│   ├── test_special.py      # Специальные тесты (delayed response)
│   ├── test_users.py        # Тесты пользователей
│   ├── conftest.py          # Pytest фикстуры
│   └── assertions.py        # Хелперы для проверок в тестах
├── pyproject.toml           # Poetry конфигурация и зависимости
├── poetry.lock              # Закрепленные версии зависимостей
├── .env                     # Переменные окружения
├── .gitignore              # Git ignore файл
├── api.log                 # Логи API (генерируется автоматически)
└── README.md               # Документация проекта
```

## Тесты

**Smoke тесты (4 теста):**

- ✅ Проверка доступности сервиса
- ✅ Статус приложения
- ✅ Основные эндпоинты
- ✅ Структура данных

**Пользователи (7 тестов):**

- ✅ Список пользователей (пагинация)
- ✅ Вторая страница пользователей
- ✅ Получение пользователя по ID
- ✅ 404 для несуществующих пользователей
- ✅ Уникальность ID пользователей

**CRUD операции (5 тестов):**

- ✅ Создание пользователя (POST)
- ✅ Полное обновление пользователя (PUT)
- ✅ Частичное обновление пользователя (PATCH)
- ✅ Удаление пользователя (DELETE)
- ✅ Обновление несуществующего пользователя

**Ресурсы (4 теста):**

- ✅ Список ресурсов (пагинация)
- ✅ Получение ресурса по ID
- ✅ 404 для несуществующих ресурсов
- ✅ Вторая страница ресурсов

**Аутентификация (18 тестов):**

- ✅ Успешная регистрация
- ✅ Неуспешная регистрация (отсутствует пароль)
- ✅ Успешный логин
- ✅ Неуспешный логин (отсутствует пароль)
- ✅ Валидация email при регистрации (7 тестов)
- ✅ Валидация email при логине (5 тестов)
- ✅ Обработка отсутствующего email
- ✅ Обработка пустого email

**Специальные тесты (2 теста):**

- ✅ Задержанные ответы (delay параметр)
- ✅ Измерение времени выполнения

**Итого: ~40 тестов**

## Особенности

- **Автоматическая проверка доступности сервиса** перед запуском тестов
- **Модульная структура тестов** - каждая функциональная область в отдельном файле
- **Email валидация** с использованием `email-validator`
- **Параметризованные тесты** для покрытия различных сценариев
- **Понятные сообщения об ошибках** вместо пустых ответов
- **Delayed response** для тестирования производительности
- **Тестовые данные** генерируются с помощью `mimesis`
- **Универсальные хелперы** для проверок в `assertions.py`
- **Структура файлов** разделена на `app/` и `tests/`
- **Автоматическая загрузка** переменных окружения в тестах